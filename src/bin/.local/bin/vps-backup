#!/bin/bash
# Back up files from my VPS.

sudo mountpoint /mnt &> /dev/null
mounted=$?
target_dir="/mnt/Remi/media/archives/nabiki"

if [ $mounted -ne 0 ]; then
  echo "Mount backup drive first, dummy! （╯°□°）╯︵ ┻━┻"
  exit 1;
fi

echo "OK, backing up from nabiki."
ssh root@nabiki.rkm.id.au /bin/bash <<EOF
echo "Backing up SQL databases ... [postfix_db]"
mysqldump --lock-tables -h localhost -u root \
  -p"$(pass ls machines/nabiki/root@mysql)" \
  postfix_db > postfix_db.sqlbackup
echo "Backing up SQL databases ... [owncloud]"
mysqldump --lock-tables -h localhost -u root \
  -p"$(pass ls machines/nabiki/root@mysql)" \
  owncloud > owncloud.sqlbackup
echo "Backing up SQL databases ... [piwik]"
mysqldump --lock-tables -h localhost -u root \
  -p"$(pass ls machines/nabiki/root@mysql)" \
  piwik > piwik.sqlbackup
echo "Backing up SQL databases ... done!"
EOF

sudo test -d "${target_dir}" || sudo mkdir "${target_dir}"

sudo rsync -aAX \
      --exclude="/dev" \
      --exclude="/proc" \
      --exclude="/sys" \
      --exclude="/tmp" \
      --exclude="/run" \
      --exclude="/mnt" \
      --exclude="/media" \
      --exclude="/lost+found" \
      --info=progress2 \
      --delete-after \
      root@nabiki.rkm.id.au:/ "${target_dir}"
